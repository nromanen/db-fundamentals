 --1 Show first and last names of the employees who have the biggest freight
select e.first_name, e.last_name 
from employees e, orders o  
where o.employee_id = e.employee_id 
and o.freight = (select max(freight)
from orders o)

--2 Show first, last names of the employees, their freight who have the freight bigger then avarage.
select e.first_name, e.last_name 
from employees e, orders o  
where o.employee_id = e.employee_id 
and o.freight > (select avg(freight)
from orders o)
group by e.first_name, e.last_name

--3 Show the names of products, that have the biggest price.
select p.product_name 
from products p 
where p.unit_price = (select max(unit_price) from products p2) 

--4 Show the name of customers with the freight bigger then avarage.
select c.company_name 
from customers c 
join orders o on c.customer_id = o.customer_id 
where o.freight >= (select avg(o2.freight) from orders o2)
group by c.company_name

--5 Show the name of supplier  who delivered the cheapest product.
select s.company_name 
from suppliers s 
join products p on p.supplier_id = s.supplier_id 
where p.unit_price = (select min(unit_price) from products)



/*1 Show the name of the category in which the average price of  
a certain product is greater than the grand average in the whole stock.*/

select c.category_name 
from categories c 
where c.category_id in 
(select p.category_id, p.product_id  from products p
where p.product_id in 
(select od.product_id from order_details od 
where unit_price > (select avg(unit_price) from order_details od2)))
group by c.category_name

/*2 Show the name of the supplier whose delivery  is lower than the grand average in the whole stock.*/

select s.company_name 
from suppliers s 
join products p on p.supplier_id = s.supplier_id 
join order_details od on p.product_id = od.product_id 
join orders o on o.order_id = od.order_id 
where (o.shipped_date - o.order_date) < (select avg(o.shipped_date - o.order_date)
from orders o)
group by s.company_name 

/*3 Show the regions where employees work, the middle age of which is higher than over the whole company.*/

select e.region 
from employees e 
where date_part('Year', age(e.birth_date)) > (select avg(date_part('Year', age(e.birth_date)))
from employees e)
group by e.region 

/*4 Show customers whose maximum freight level is less than the average for all customers. */

select c.company_name,
max(o.freight)
from customers c 
join orders o on o.customer_id = c.customer_id 
group by c.company_name
having max(o.freight) <
(select avg(o.freight)
from orders o)

/*5 Show the categories of products for which the average discount is higher than the average discount for all products*/
select c.category_name, avg(od.discount)
from categories c 
join products p on p.category_id = c.category_id 
join order_details od on od.product_id = p.product_id 
group by c.category_name 
having avg(od.discount) > (select avg(od2.discount) from order_details od2)



/*1 Calculate the average freight of all employees who work not with Western region.*/
select avg(o.freight)
from orders o 
where o.employee_id in 
(select e.employee_id from employees e 
where e.region != 'WA' or e.region is null)

/*2 Show first and last names of employees who shipped orders in cities of USA.*/
select e.first_name
, e.last_name 
from employees e 
where e.employee_id in (select o.employee_id 
from orders o
where o.ship_country = 'USA')


/*3 Show the names of products and their total cost, which were delivered by German suppliers */
select p.product_name 
, Sum(od.unit_price * od.quantity * (1 - od.discount)) :: numeric(18, 2)
from products p 
join order_details od on od.product_id = p.product_id 
where p.supplier_id in (select supplier_id from suppliers s where s.country = 'Germany')
group by p.product_name

/*4 Show first and last names of employees that donâ€™t work with Eastern region. */

select e.first_name
, e.last_name 
from employees e
where e.employee_id in (select et.employee_id from employee_territories et
where et.territory_id in (select t.territory_id  from territories t 
where t.region_id in (select r.region_id  from region r
where r.region_description != 'Eastern')))


/*5 Show the name of customers that prefer to order non-domestic products. */

select a.company_name, a.domestic, a.non_domestic
from (select c.company_name 
, sum(case
	when c.country = s.country 
	then od.unit_price * od.quantity * (1- od.discount) 
end) :: numeric(18,2)  as domestic
, sum(case
	when c.country <> s.country 
	then od.unit_price * od.quantity * (1- od.discount) 
end) :: numeric(18,2)  as non_domestic
from customers c
join orders o on c.customer_id = o.customer_id 
join order_details od on od.order_id  = o.order_id 
join products p on p.product_id = od.product_id 
join suppliers s on s.supplier_id = p.supplier_id 
group by c.company_name) as a
where a.non_domestic > a.domestic

