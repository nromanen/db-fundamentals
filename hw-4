--Show the list of first and last names and ages of the employees over 55. The result should be sorted by last name.
select 
	first_name,
	last_name, 
	extract(year from age(now(),birth_date)) as "Age"
from employees
where extract(year from age(now(),birth_date))>55
order by last_name;

--Calculate the greatest, the smallest and the average age among the employees from London.
select
	max(extract(year from age(now(),birth_date))) as max_age,
	min(extract(year from age(now(),birth_date))) as min_age,
	avg(extract(year from age(now(),birth_date))) as avg_age
from employees 
where city like 'London'
group by city;

--Calculate the greatest, the smallest and the average age of the employees for each city.
select
	city,
	max(extract(year from age(now(),birth_date))) as max_age,
	min(extract(year from age(now(),birth_date))) as min_age,
	avg(extract(year from age(now(),birth_date))) as avg_age
from employees 
group by city;

--Show first, last names and dates of birth of the employees who celebrate their birthdays this month.
select 
	first_name,
	last_name,
	birth_date 
from employees 
where date_part('month', birth_date) = date_part('month', now()); 

--Show first and last names of the employees who used to serve orders shipped to Madrid. The result set would be ordered by first name.
select distinct  
	e.first_name,
	e.last_name
from employees e
inner join orders o 
on e.employee_id = o.employee_id 
where o.ship_city like 'Madrid'
order by e.first_name; 

/*Write the query, which will show the first and last names of the employees (whether they served orders or not) as well as the count of orders (CountOfOrders) where served by each of them. 

Note. Use LEFT join*/
select
	e.first_name,
	e.last_name,
	count(o.order_id) as count_of_orders
from employees e 
left join orders o 
	on e.employee_id =o.employee_id 
group by e.first_name, e.last_name 	
order by e.first_name; 

--Show first and last names of the employees as well as the count of their orders shipped after required date during the year 1997 (use left join).
select
	e.first_name,
	e.last_name,
	count(o.order_id) as count_of_orders
from employees e 
left join orders o 
	on e.employee_id = o.employee_id 
	and extract(year from o.order_date) = 1997 and o.shipped_date>o.required_date 
group by e.first_name, e.last_name
order by e.first_name; 

--Show the list of french customers’ names who have made more than one order (use grouping).
select
	c.contact_name,
	count(o.order_id) as count_of_orders
from customers c 
	inner join orders o 
	on c.customer_id = o.customer_id 
where c.country like 'France'	
group by c.contact_name 
having count(o.order_id)>1
order by c.contact_name;

--Вивести товари, які мають найбільшу сумму відхилень від заданної ціни в замовленнях
select 
	p.product_name
from products p 
inner join order_details od 
	on p.product_id = od.product_id 
	and p.unit_price != od.unit_price 
group by p.product_name
having sum(abs(p.unit_price-od.unit_price)) = (select 
		sum(abs(p.unit_price-od.unit_price))
	from products p 
	inner join order_details od 
		on p.product_id = od.product_id 
		and p.unit_price != od.unit_price 
	group by p.product_name
	order by sum(abs(p.unit_price-od.unit_price )) desc
	limit 1);
	
/*In the OrderDetails table, we have the fields UnitPrice and Quantity. Write the query which will return 
 * the OrderID, ProductsAmount (amount of products counted by ProductID in each order)  an additional 
 * column TotalPrice (containing the sum of values that multiply UnitPrice and Quantity). 
 * The result set will contain only data about orders with ProductsAmount of more than 5 
 * and will be ordered by OrderID (ascending) and ProductsAmount (descending).*/
select 
	order_id,
	count(product_id) as product_amount,
	sum(unit_price*quantity) as total_price
from order_details 
group by order_id
having count(product_id)>5
order by order_id, sum(unit_price*quantity) desc;

/*Show a list of all the different values in the Customers table for ContactTitles. Also include an amount (count) 
 * for each ContactTitle with the alias ContactTitlesAmount. The result set would be ordered by ContactTitlesAmount 
 * in descending order.*/
select 
	contact_title, 
	count(customer_id) as contact_title_amount
from customers 
group by contact_title 
order by count(customer_id) desc;

/*Show the list of the calculated number of orders (AmountOfLateOrders), which were shipped (ShipDate) 
 * after the required date (RequiredDate) by employees, which would be represented in the result set 
 * with their EmployeeID. Include into the list only rows with the AmountOfLateOrders equals and more than 5.*/
select 
	employee_id,
	count(order_id) as amount_of_late_orders
from
	orders 
where shipped_date > required_date 	
group by employee_id 
having count(order_id) >=5
order by employee_id;

/*Show the FirstName and LastName columns from the Employees table, and then create a new column called FullName, 
 showing FirstName and LastName joined together in one column, with a space in between for those employees, 
 who live in the USA or Germany.*/
select 
	first_name,
	last_name,
	first_name ||' '||last_name as full_name
from employees 
where country in ('USA', 'Germany');
